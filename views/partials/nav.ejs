<nav class="nav">
    <div class="nav-container">
        <a href="/dashboard" class="nav-brand">
            <img src="/images/logo.png" alt="Logo" style="width: 32px; height: 32px; object-fit: contain;">
            <span>SchoologyUltra</span>
        </a>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="nav-links">
            <a href="/dashboard" class="nav-link <%= active === 'dashboard' ? 'active' : '' %>">
                <span>Dashboard</span>
            </a>
            <a href="/assignments" class="nav-link <%= active === 'assignments' ? 'active' : '' %>">
                <span>Assignments</span>
            </a>
            <a href="/grades" class="nav-link <%= active === 'grades' ? 'active' : '' %>">
                <span>Grades</span>
            </a>
            <div class="nav-dropdown <%= active === 'courses' ? 'active' : '' %>">
                <a href="/courses" class="nav-link">
                    <span>Courses</span>
                </a>
                <div class="nav-dropdown-menu">
                    <ul role="menu">
                        <% const navSource = (typeof navSections !== 'undefined' && navSections) ? navSections : (sections || []);
                           const ordered = (navSource || []).slice().map(s => ({
                            id: s.section_id || s.id || s.sectionId,
                            title: s.course_title || s.section_title || s.courseName || '',
                            grade: (s.final_grade !== undefined && s.final_grade !== null && String(s.final_grade).trim() !== '') ? parseFloat(s.final_grade) : (s.grade !== undefined && s.grade !== null && String(s.grade).trim() !== '') ? parseFloat(s.grade) : null,
                            unavailable: !!s.grade_unavailable,
                            has_grades: !!s.has_grades
                        })).sort((a,b) => {
                            const aHas = a.grade !== null && !isNaN(a.grade);
                            const bHas = b.grade !== null && !isNaN(b.grade);
                            if (aHas && !bHas) return -1;
                            if (!aHas && bHas) return 1;
                            return (a.title || '').localeCompare(b.title || '');
                        });
                        const dividerIndex = ordered.findIndex(c => c.grade === null || isNaN(c.grade));
                        if (ordered.length === 0) { %>
                            <li style="color: var(--text-tertiary); padding: var(--space-3) var(--space-4);">No courses</li>
                        <% } else {
                            ordered.forEach((c, idx) => { %>
                        <% if (idx === dividerIndex && idx !== 0) { %>
                        <li class="nav-course-divider" aria-hidden="true"><hr></li>
                        <% } %>
                        <li>
                            <a href="/courses?section=<%= c.id %>" class="nav-course-item" role="menuitem">
                                <span class="nav-course-title"><%= c.title %></span>
                                <span class="nav-course-grade">
                                    <%= (c.grade !== null && !isNaN(c.grade)) ? c.grade.toFixed(2) + '%' : (c.unavailable ? 'Unavailable' : (c.has_grades ? 'Has grades' : 'N/A')) %>
                                </span>
                            </a>
                        </li>
                        <% }) } %>
                    </ul>
                </div>
            </div>
            <a href="/focus" class="nav-link <%= active === 'focus' ? 'active' : '' %>">
                <span>Focus</span>
            </a>
        </div>
        <div class="nav-user">
            <a href="/settings" class="nav-icon-link <%= active === 'settings' ? 'active' : '' %>" title="Settings">
                <div class="nav-icon-wrapper">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </div>
            </a>
            <a href="/inbox" class="nav-icon-link <%= active === 'inbox' ? 'active' : '' %>" title="Inbox">
                <div class="nav-icon-wrapper">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="inbox-badge" style="display: none;">0</span>
                </div>
            </a>
            <a href="/logout" class="nav-icon-link nav-logout" title="Logout">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </a>
        </div>
    </div>
</nav>

<script>
// Check for unread notifications on every page
(function() {
    const badge = document.querySelector('.inbox-badge');
    if (badge) {
        badge.style.display = 'flex';
        badge.textContent = '';
        badge.classList.add('skeleton', 'skeleton-pill', 'skeleton-muted');
        badge.style.width = '32px';
        badge.style.height = '18px';
    }

    fetch('/api/notifications/count')
        .then(r => r.json())
        .then(data => {
            if (badge) {
                badge.classList.remove('skeleton', 'skeleton-pill', 'skeleton-muted');
                badge.style.width = '';
                badge.style.height = '';
                if (data.count > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = data.count > 9 ? '9+' : data.count;
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(() => {
            if (badge) badge.style.display = 'none';
        });
})();

// Mobile menu toggle
function toggleMobileMenu() {
    const navLinks = document.querySelector('.nav-links');
    const toggle = document.querySelector('.mobile-menu-toggle');
    navLinks.classList.toggle('mobile-open');
    toggle.classList.toggle('active');
}

// Close mobile menu when clicking outside
if (!window.__schoologyUltraMobileMenuCloseBound) {
    window.__schoologyUltraMobileMenuCloseBound = true;
    document.addEventListener('click', function(event) {
        const nav = document.querySelector('.nav');
        const navLinks = document.querySelector('.nav-links');
        const toggle = document.querySelector('.mobile-menu-toggle');

        if (!nav || !navLinks || !toggle) return;
        if (navLinks.classList.contains('mobile-open') && !nav.contains(event.target)) {
            navLinks.classList.remove('mobile-open');
            toggle.classList.remove('active');
        }
    });
}

// Dropdown toggle (mobile/touch-friendly) and accessible keyboard support
if (!window.__schoologyUltraDropdownBound) {
    window.__schoologyUltraDropdownBound = true;
    (function() {
        const dropdowns = Array.from(document.querySelectorAll('.nav-dropdown'));
        if (!dropdowns.length) return;

        dropdowns.forEach(dd => {
            const link = dd.querySelector('a.nav-link');
            link.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024) {
                    // On small screens, toggle dropdown instead of navigating
                    e.preventDefault();
                    dd.classList.toggle('open');
                }
            });

            // Close dropdown on escape
            dd.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') dd.classList.remove('open');
            });
        });

        // Close if clicking outside
        document.addEventListener('click', (ev) => {
            dropdowns.forEach(dd => {
                if (dd.classList.contains('open') && !dd.contains(ev.target)) dd.classList.remove('open');
            });
        });
    })();
}
</script>
